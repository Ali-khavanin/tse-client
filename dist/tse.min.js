const tse=function(){let t="http://service.tsetmc.com/tsev2/data/TseClient2.aspx";const e={t(t){const e={o:"Instrument",a:""+t};return this.i(e)},u(t,e=0){const s={o:"InstrumentAndShare",a:""+t,l:""+e};return this.i(s)},h(){return this.i({o:"LastPossibleDeven"})},P(t){const e={o:"ClosingPrices",a:""+t};return this.i(e)},i(e){const s=new URL(t);return s.search=new URLSearchParams(e).toString(),new Promise(((t,e)=>{fetch(s).then((async s=>{200===s.status?t(await s.text()):e(s.status+" "+s.statusText)})).catch((t=>e(t)))}))}};class s{constructor(t=""){const e=t.split(",");if(11!==e.length)throw new Error("Invalid ClosingPrice data!");this.m=e[0],this.g=e[1],this.C=e[2],this.I=e[3],this.D=e[4],this.S=e[5],this._=e[6],this.T=e[7],this.U=e[8],this.v=e[9],this.A=e[10]}}const n=["CompanyCode","LatinName","Symbol","Name","Date","ShamsiDate","PriceFirst","PriceMax","PriceMin","LastPrice","ClosingPrice","Price","Volume","Count","PriceYesterday"],r=["کد شرکت","نام لاتین","نماد","نام","تاریخ میلادی","تاریخ شمسی","اولین قیمت","بیشترین قیمت","کمترین قیمت","آخرین قیمت","قیمت پایانی","ارزش","حجم","تعداد معاملات","قیمت دیروز"];class o{constructor(t=[]){const e=t.length;if(e>2||e<1)throw new Error("Invalid Column data!");this.name=n[t[0]],this.p=r[t[0]],this.R=t[1]}}class i{constructor(t=""){const e=t.split(",");if(18!==e.length)throw new Error("Invalid Instrument data!");this.m=e[0],this.L=e[1],this.j=e[2],this.N=e[3],this.O=e[4],this.Symbol=e[5].replace(/\u200B/g,"").replace(/\s?\u200C\s?/g," ").replace(/\u200D/g,"").replace(/\uFEFF/g,"").replace(/ك/g,"ک").replace(/ي/g,"ی"),this.F=e[6],this.Y=e[7],this.g=e[8],this.M=e[9],this.B=e[10],this.$=e[11],this.q=e[12],this.V=e[13],this.H=e[14],this.K=e[15].trim(),this.k=e[16].trim(),this.W=e[17]}}class a{constructor(t=""){const e=t.split(",");if(5!==e.length)throw new Error("Invalid Share data!");this.J=e[0],this.m=e[1],this.g=e[2],this.Z=parseInt(e[3]),this.G=parseInt(e[4])}}function c(t=!1,e=!1,s="InsCode"){const n=localStorage.getItem("tse.instruments").split(";"),r=e?[]:{};for(const o of n){const n=t?new i(o):o;if(e)r.push(n);else{r[t?n[s]:o.match(/^\d+\b/)[0]]=n}}return r}function u(t){return 1e4*t.getFullYear()+100*(t.getMonth()+1)+t.getDate()+""}function l(t,e){const s=+new Date(+t.slice(0,4),+t.slice(4,6)-1,+t.slice(6,8)),n=+new Date(+e.slice(0,4),+e.slice(4,6)-1,+e.slice(6,8)),r=Math.abs(n-s);return Math.ceil(r/864e5)}function f(t){return new Promise((e=>setTimeout(e,t)))}function h(t,e,s){const n=t;return"CompanyCode"===n?e.O:"LatinName"===n?e.N:"Symbol"===n?e.Symbol.replace(" ","_"):"Name"===n?e.F.replace(" ","_"):"Date"===n?s.g:"ShamsiDate"===n?function(t){const{X:e,tt:s,et:n}=jalaali.toJalaali(+t.slice(0,4),+t.slice(4,6),+t.slice(6,8));return 1e4*e+100*s+n+""}(s.g):"PriceFirst"===n?s.A:"PriceMax"===n?s.U:"PriceMin"===n?s.T:"LastPrice"===n?s.I:"ClosingPrice"===n?s.C:"Price"===n?s._:"Volume"===n?s.S:"Count"===n?s.D:"PriceYesterday"===n?s.v:""}Big.DP=40,Big.RM=2;let d=1,P=10,w=500,m=3,g=5e3;const C={columns:[[4,"date"],[6,"open"],[7,"high"],[8,"low"],[9,"last"],[10,"close"],[12,"vol"]],st:0,nt:!1,rt:"20010321"},{warn:E}=console,I={};async function b(){let t,s=localStorage.getItem("tse.lastPossibleDeven");if(s){const e=new Date,r=l(u(e),s),o=[4,5].includes(e.getDay()),i=(n=s,new Date(+n.slice(0,4),+n.slice(4,6)-1,+n.slice(6,8))).getDay();t=r>=d&&!(o&&3!==i&&r<=3)}else t=!0;var n;if(t){let t;const n=await e.h().catch((e=>t=e));if(t)throw new Error("Failed request: ","LastPossibleDeven: ",`(${t})`);if(!/^\d{8};\d{8}$/.test(n))throw new Error("Invalid server response: LastPossibleDeven");s=n.split(";")[0]||n.split(";")[1],localStorage.setItem("tse.lastPossibleDeven",s)}return+s}async function D(){let t,s,n,r;if(localStorage.getItem("tse.lastInstrumentUpdate")){n=c(),r=function(t=!1,e=!1,s="InsCode"){const n=localStorage.getItem("tse.shares").split(";"),r=e?[]:{};for(const o of n){const n=t?new a(o):o;e?r.push(n):r[t?n[s]:o.split(",",2)[1]]=n}return r}();const e=Object.keys(n).map((t=>parseInt(n[t].match(/\b\d{8}\b/)[0]))),o=Object.keys(r).map((t=>parseInt(r[t].split(",",1)[0])));t=Math.max(...e),s=Math.max(...o)}else t=0,s=0;if(l(""+t,""+await b())<d)return;let o;const i=await e.u(t,s).catch((t=>o=t));if(o)return void E("Failed request: InstrumentAndShare",`(${o})`);const f=i.split("@");let h=f[0],P=f[1];"*"===h&&E("Cannot update during trading session hours."),""===h&&E("Already updated: ","Instruments"),""===P&&E("Already updated: ","Shares"),""!==h&&"*"!==h&&(n&&Object.keys(n).length&&(h.split(";").forEach((t=>n[t.match(/^\d+\b/)[0]]=t)),h=Object.keys(n).map((t=>n[t])).join(";")),localStorage.setItem("tse.instruments",h)),""!==P&&(r&&r.length&&(P.split(";").forEach((t=>r[t.split(",",1)[0]]=t)),P=Object.keys(r).map((t=>r[t])).join(";")),localStorage.setItem("tse.shares",P)),(""!==h&&"*"!==h||""!==P)&&localStorage.setItem("tse.lastInstrumentUpdate",u(new Date))}async function S(t=[]){let s;const n=(t,e,s)=>({result:t,error:e,ot:s}),r=t.map((t=>t.it.join(","))).join(";");let o;const i=await e.P(r).catch((t=>o=t));if(o)return s=n(t,"Failed request: ClosingPrices",o),s;if(!/^[\d\.,;@\-]*$/.test(i))return s=n(t,"Invalid server response: ClosingPrices"),s;if(""===i)return s=n(t,"Unknown Error."),s;const a={};return i.split("@").forEach(((e,s)=>a[t[s].at]=e)),s=n(a),s}async function y(t={},e=0,s={}){const n=Object.keys(t),r=(o=n,i=P,o.map(((t,e)=>e%i==0?o.slice(e,e+i):void 0)).filter((t=>t))).map((e=>e.map((e=>t[e]))));var o,i;const a=[];for(const t of r)a.push(S(t)),await f(w);const c=(await Promise.allSettled(a)).map((t=>t.value)),u=c.filter((t=>t.error)).reduce(((t,{result:e})=>e.forEach((e=>t[e.at]=e))||t),{}),l=c.filter((t=>!t.error)).reduce(((t,{result:e})=>Object.keys(e).forEach((s=>t[s]=e[s]))||t),{});return s.ct={...s.ct,...l},s.ut={...u},++e>m||Object.keys(u).length&&(s=await new Promise((async(t,n)=>{await f(g);t(await y(u,e,s))}))),s}async function _(t=[],e){if(!t.length)return;const n=await b(),r={};for(const o of t){const t=o.m,i="NO"===o.V?0:1,a=I[t];if(a){const e=a.split(";"),o=+new s(e[e.length-1]).g;l(""+o,""+n)>=d&&(r[t]={it:[t,o,i],at:t,lt:a})}else r[t]={it:[t,e,i],at:t}}let o={ct:{},ut:{}};if(!Object.keys(r).length)return o;const{ct:i,ut:a}=await y(r),c=Object.keys(i);for(const t of c){const{lt:e}=r[t],s=i[t];let n=e||"";s&&(n=e?e+";"+s:s),I[t]=n}let u="";const f=Object.keys(I);for(let t=0,e=f.length;t<e;t++)u+=I[f[t]]+"@";return u=u.slice(0,-1),await localforage.setItem("tse.prices",u),o}return{ft:async function(t=!0,e=!0,s="InsCode"){return await D(),c(t,e,s)},ht:async function(t=[],e={}){if(!t.length)return;await D();const n=c(!0,void 0,"Symbol"),r=t.map((t=>n[t])),i=t.filter(((t,e)=>!r[e]));if(i.length)return void console.error("Incorrect symbol names:",i);e={...C,...e};const{st:u,rt:l,nt:f}=e;await async function(){const t=await localforage.getItem("tse.prices");if(!t)return I;const e=t.split("@");for(let t=0,s=e.length;t<s;t++){const s=e[t];s&&(I[s.match(/^\b\d+\b/)[0]]=s)}}();const{ct:d,ut:P}=await _(r,l),[w,g]=[d,P].map((t=>Object.keys(t).length));if(g){E(`Incomplete Price Update:  Failed: ${g} - Updated: ${w} (after ${m} retries)`);const t=Object.keys(P);r.forEach(((e,s,n)=>t.includes(e.m)?n[s]=void 0:0))}const b={};for(const t of r){if(!t)continue;const e=t.m,n=I[e];n&&(b[e]=n.split(";").map((t=>new s(t))))}const S=localStorage.getItem("tse.shares").split(";").map((t=>new a(t))),y=e.columns.map((t=>new o(Array.isArray(t)?t:[t])));return r.map((t=>{if(!t)return;const e={},s=y.map((t=>{const s=t.R||t.name;return e[s]=[],{...t,R:s}})),n=t.m;if(!b[n])return e;const r=1===u||2===u?function(t,e,s,n){const r=e,o=e.length,i=[];if((1===t||2===t)&&o>1){let e=new Big("0.0"),a=new Big("1.0");if(i.push(r[o-1]),1===t)for(let t=o-2;t>=0;t-=1)Big(r[t].C).eq(r[t+1].v)||(e=e.dt(1));if(1===t&&e.div(o).Pt("0.08")||2===t)for(let e=o-2;e>=0;e-=1){const o=r[e],c=r[e+1],u=!Big(o.C).eq(c.v),l=s.find((t=>t.m===n&&t.g===c.g));if(1===t&&u)a=a.wt(c.v).div(o.C);else if(2===t&&u&&l){const t=l.G,e=l.Z;a=a.wt(t).div(e)}let f=a.wt(o.C).round(2).toFixed(2),h=a.wt(o.I).round(2).toFixed(2),d=a.wt(o.T).round().toString(),P=a.wt(o.U).round().toString(),w=a.wt(o.v).round().toString(),m=a.wt(o.A).round(2).toFixed(2);const g={m:o.m,g:o.g,C:f,I:h,D:o.D,S:o.S,_:o._,T:d,U:P,v:w,A:m};i.push(g)}}return i.reverse()}(u,b[n],S,n):b[n];for(const n of r)if(!Big(n.g).Pt(l)&&(!Big(n.D).eq(0)||f))for(const{R:r,name:o}of s){const s=h(o,t,n);e[r].push(/^\d+(\.?\d+)?$/.test(s)?parseFloat(s):s)}return e}))},get gt(){return t},set gt(e){if("string"!=typeof e)return;let s;try{new URL(e)}catch(t){throw s=!0,t}s||(t=e)},get Ct(){return d},set Ct(t){Number.isInteger(t)&&(d=t)},get Et(){return P},set Et(t){Number.isInteger(t)&&t>0&&t<60&&(P=t)},get It(){return w},set It(t){Number.isInteger(t)&&(w=t)},get bt(){return m},set bt(t){Number.isInteger(t)&&(m=t)},get Dt(){return g},set Dt(t){Number.isInteger(t)&&(g=t)},get St(){return[...Array(15)].map(((t,e)=>({name:n[e],p:r[e]})))}}}();